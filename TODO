
Zetesis Execution Backlog — 2025-11-04

Priority legend: P0 = immediate; P1 = next; P2 = later

Legend: [ ] = open · [~] = in progress · [x] = done

## Authoring Checklist
- Start each work package with a stable identifier (e.g., `WP-CLI — Command Surface`) so it can be referenced from `SPEC`.
- Nest work items beneath their work package using `- [ ] ID: description (Pn)` to capture priority and ownership context.
- When progress updates occur, change only the status marker `[ ]/[~]/[x]` and the trailing note; do not reorder completed items.
- Link back to requirements in `SPEC` with parenthetical tags like `(covers REQ-ZE-CLI-FIRST)` for traceability.
- Record handoff notes or follow-ups inline after an em dash (e.g., `— awaiting API keys`) instead of creating new bullets for commentary.
- Revisit TODO daily on active projects; promote new work only after confirming SPEC stays in sync.

## Work Package Template
- WP-NAME — Concise title
  - [ ] T1: Description of the task and acceptance criteria (P0)
  - [ ] T2: Next task in the same scope (P1)
  - [ ] Tn: Additional tasks as needed (Pn)

## WP-SPEC — Bring SPEC/TODO In Sync
- [x] T1: Derive SPEC from current code; add CLI, OCR, Jobs, Identity, Index details (P0) (covers REQ-ZE-SPEC-TRACE, REQ-ZE-INDEX-FIELDS, REQ-ZE-CLI-CMDS)
- [ ] T2: Add SPEC verification checklist to CI (clippy fmt test invoke, fail on drift) (P1) (covers REQ-ZE-SPEC-CADENCE)

## WP-BLOBS — Content-Addressed Storage
- [x] T3: Define `BlobStore` trait (`put`/`get`/`head`/`delete`, CID=idempotent, streaming) + property tests (P0) (covers REQ-ZE-STORAGE-FS, REQ-ZE-ID-CANONICAL)
- [x] T4: Implement `FsBlobStore` over `AppPaths::blob_path` with checksum-on-write and size verification (P0) (covers REQ-ZE-STORAGE-FS)
- [x] T5: Implement `S3BlobStore` using an S3 library (for Hetzner) behind feature flag + config stubs (P1) (covers REQ-ZE-STORAGE-FS) — Completed 2025-11-04: Added aws-sdk-s3 backend with path-style addressing, key layout mirroring, comprehensive tests, and documentation
- [x] T6: Migrate KIO/SAOS download paths to `BlobStore` API; deprecate ad-hoc caches; E2E move test (P1) (covers REQ-ZE-STORAGE-FS) — Completed 2025-11-05: Refactored KIO scrapers to stream HTTP → BlobStore, replaced filesystem caching with content-addressable storage, added CLI backend selection (S3/FS), implemented manifest writer for doc_id→CID ledger, added E2E integration tests with mock HTTP server, fixed S3 error handling panics

## WP-CLI — Command Surface
- [x] T7: Remove dead CLI (`ocr`, `segment`) and unreachable wiring; keep services internal; update SPEC + help output tests (P0) (covers REQ-ZE-CLI-CMDS)
- [x] T8: Validate index names and file size bounds at parse time; add negative tests (P1) (covers REQ-ZE-CLI-LIMITS)
- [x] T9: Add examples and `--help` coverage for `search keyword|vector` including filters and fields (P2) (covers REQ-ZE-CLI-SEARCH)

## WP-SERVER — HTTP Surface
- [x] T10: Implement Axum POC with `/healthz` + graceful shutdown (P0) (covers REQ-ZE-CLI-CMDS)
- [x] T11: Add `/v1/search/keyword` and `/v1/search/vector` endpoints mirroring CLI options; reuse index/search code paths (P1) (covers REQ-ZE-INDEX-SEARCHABLE) — Completed 2025-11-06: shared search service, HTTP validation, regression tests for 400/404 cases
- [x] T12: Logging, rate limits, and error mapping to structured JSON (P1) (covers REQ-ZE-LOGS, REQ-ZE-ASSERTS)
- [x] T13: Config load from env/files; XDG-aware paths; CORS off by default (P2) — Completed 2025-11-07: Added TOML-only precedence, env overrides, and configurable CORS defaults
- [ ] T14: Typeahead-optimized keyword endpoint: small fields, limit ≤ 10, p95 ≤ 100 ms; per-IP rate limit and 2s LRU cache (P0) (covers REQ-ZE-UI-TYPEAHEAD)

## WP-UI — Dioxus 0.7 (SSR + Islands)
- [ ] T15: Minimal SSR route `/ui/hello` rendered by Dioxus 0.7; CI check for gzipped bundle ≤ 150 KiB (P0) (covers REQ-ZE-UI-DIOXUS)
- [ ] T16: Wire Dioxus SSR into Axum under `/ui/*`; keep `/v1/*` JSON APIs separate (P0) (covers REQ-ZE-UI-AXUM)
- [ ] T17: Implement search page: SSR shell + hydrated results island with typeahead (debounce 200ms, min 2 chars, limit 10, cancellable) (P1) (covers REQ-ZE-UI-TYPEAHEAD)
- [ ] T18: Add “Refine with semantics” action to run hybrid once (RRF, bounded k), swap results (P1) (covers REQ-ZE-UI-REFINE)
- [ ] T19: Admin status page: SSR table (index stats, job counts); optional tiny hydrated badge for live counters (P1) (covers REQ-ZE-UI-DIOXUS)
- [ ] T20: SSG build for static pages (landing/help) and static assets pipeline (public/ + caching) (P2) (covers REQ-ZE-UI-SSG, REQ-ZE-UI-ASSETS)

## WP-AUTH — OAuth2/OIDC Integration
- [ ] T21: Document oauth2-proxy setup (Hetzner), header trust model, and network placement (P0) (covers REQ-ZE-AUTH-PROXY)
- [ ] T22: Optional JWT verification middleware (JWKS cache, aud/iss checks, clock skew) behind feature flag (P1) (covers REQ-ZE-AUTH-JWT)
- [ ] T23: API key path for programmatic clients (scoped routes, disabled by default) (P1) (covers REQ-ZE-AUTH-API-KEY)

## WP-INGEST — Ingestion Pipeline
- [ ] T24: Route KIO/SAOS downloaded PDFs to blob store via `AppPaths::blob_path` (content-addressed) and store CID reference (P0) (covers REQ-ZE-STORAGE-FS, REQ-ZE-ID-CANONICAL)
- [ ] T25: Add end-to-end ingest test that indexes a tiny PDF fixture and verifies `doc` + `chunk` shapes (P1) (covers REQ-ZE-INDEX-IDEMPOTENT, REQ-ZE-INDEX-FIELDS)

## WP-INDEX — Milli Configuration
- [ ] T26: Property test for index bootstrap: searchable/filterable/sortable sets equal SPEC; primary key=`id`; Hannoy backend; embedder dims (P1) (covers REQ-ZE-INDEX-EMBEDDER, REQ-ZE-INDEX-SEARCHABLE, REQ-ZE-INDEX-FILTERABLE, REQ-ZE-INDEX-SORTABLE)

## WP-JOBS — Embedding Jobs
- [ ] T27: Add stale job reaper and recovery (Pending/Embedding with old timestamps → mark Failed or requeue) (P1) (covers REQ-ZE-JOBS-REAPER, REQ-ZE-JOBS-LIMITS)
- [ ] T28: Add `jobs status` output with counts by status and oldest timestamp (P2) (covers REQ-ZE-JOBS-LOCAL)
- [ ] T29: Idempotency tests for enqueue/update/upsert; bounded retries policy (P2) (covers REQ-ZE-JOBS-LIMITS)

## WP-OCR — OCR Providers
- [ ] T30: Add negative tests for exceeding `MAX_PAGES_PER_DOCUMENT`, zero concurrency, and inflight budget mismatches (P1) (covers REQ-ZE-OCR-LIMITS)
- [ ] T31: Document token usage logging and provider-specific retries in docs/ocr_costs.md (P2) (covers REQ-ZE-OCR-RETRY)

## WP-HYBRID — Hybrid Search Fusion
- [ ] T32: Confirm Milli lacks built-in RRF; document hybrid support scope (P0) (covers REQ-ZE-INDEX-SEARCHABLE)
- [ ] T33: Implement client-side RRF fusion in CLI/server (run keyword + vector, fuse with k=60, bounded k); tests for tie and overlap (P1)
- [ ] T34: Add optional weighted-linear fusion with tunable weights; default to RRF (P2)

## WP-TEXT — Segmentation
- [ ] T35: Add more YAML regression cases for abbreviations and enumerations; include negative cases (P2) (covers REQ-ZE-TEXT-SEGMENT)

## WP-BACKUP — Backup & Recover
- [ ] T36: Add rotation policy and timestamped dirs for `db backup`; verify counts/sizes (P1) (covers REQ-ZE-BACKUP-RESTIC)
- [ ] T37: `db recover` integrity check (doc count, vector presence) and dry-run (P1) (covers REQ-ZE-BACKUP-RECOVER)
- [ ] T38: Restic setup to Hetzner S3 (credentials, bucket policy), systemd service+timer, retention 7/4/6 (P1) (covers REQ-ZE-BACKUP-RESTIC, REQ-ZE-BACKUP-SCOPE)
- [ ] T39: Monthly restore rehearsal into scratch path + diff stats (P2) (covers REQ-ZE-BACKUP-RECOVER)

## WP-DELETE — Hard Deletes
- [ ] T40: Implement atomic delete of doc+chunks+blob with rollback on failure; add dry-run (P0) (covers REQ-ZE-KIO-DELETE)
- [ ] T41: Negative tests (missing doc, partial state) and idempotency checks (P1)

## WP-DEPLOY — Hetzner Basics
- [ ] T42: Systemd unit, journald logs, env file; XDG base override docs (P1)
- [ ] T43: Deployment doc for Hetzner (firewall, ulimit, backups), manual first (P2)

## WP-CLI-REDESIGN — CLI Consistency and Namespaces
- [ ] T44: Introduce `--silo <slug>` for dataset-scoped commands; keep positional `INDEX` as a deprecated alias with warning (P0)
- [ ] T45: Add namespaces: `silo (list|create|stats|backup|recover|purge)`, `source (kio fetch)`, `index (alias for db)`, `sys (serve|init|doctor)` (P0)
- [ ] T46: Standardize flags across commands (`--limit/--offset/--fields/--pretty/--filter`); enforce bounds (`limit,k ≤ 100`) (P1)
- [ ] T47: Implement `sys init` (create dirs, verify RW) and `sys doctor` (API keys, paths, map sizes, rate limits) with actionable output (P1)
- [ ] T48: Update help texts and examples to prefer `--silo`; add deprecation notes for old forms (P1)
- [ ] T49: Docs: `docs/data-quickstart.md` with end-to-end flow (source→ingest→jobs→search→backup) (P1)
- [ ] T50: Migration: keep old `db` as alias to `index` and positional `INDEX` for one release; add warnings and a removal date (P2)
